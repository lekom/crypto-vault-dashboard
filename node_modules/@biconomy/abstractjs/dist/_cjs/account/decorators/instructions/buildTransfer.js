"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.buildTransfer = void 0;
const viem_1 = require("viem");
const TokenWithPermitAbi_1 = require("../../../constants/abi/TokenWithPermitAbi.js");
const composabilityCalls_1 = require("../../../modules/utils/composabilityCalls.js");
const runtimeAbiEncoding_1 = require("../../../modules/utils/runtimeAbiEncoding.js");
const buildComposable_1 = require("./buildComposable.js");
const buildTransfer = async (baseParams, parameters, composabilityParams) => {
    const { currentInstructions = [], accountAddress } = baseParams;
    const { chainId, tokenAddress, amount, gasLimit, recipient, metadata } = parameters;
    const { forceComposableEncoding } = composabilityParams ?? {
        forceComposableEncoding: false
    };
    const abi = TokenWithPermitAbi_1.TokenWithPermitAbi;
    const functionSig = "transfer";
    const args = [
        recipient,
        amount
    ];
    const functionContext = (0, runtimeAbiEncoding_1.getFunctionContextFromAbi)(functionSig, abi);
    const isComposableCall = forceComposableEncoding
        ? true
        : (0, composabilityCalls_1.isComposableCallRequired)(functionContext, args);
    let triggerCalls;
    if (isComposableCall) {
        if (!composabilityParams) {
            throw new Error("Composability params are required to build a composable call");
        }
        const composableCallParams = {
            to: tokenAddress,
            functionName: functionSig,
            args: args,
            abi,
            chainId,
            ...(gasLimit ? { gasLimit } : {})
        };
        triggerCalls = await (0, buildComposable_1.buildComposableCall)(composableCallParams, composabilityParams);
    }
    else {
        triggerCalls = [
            {
                to: tokenAddress,
                data: (0, viem_1.encodeFunctionData)({
                    abi,
                    functionName: functionSig,
                    args: args
                }),
                ...(gasLimit ? { gasLimit } : {})
            }
        ];
    }
    const defaultMetadata = [
        {
            type: "TRANSFER",
            tokenAddress: (0, composabilityCalls_1.isRuntimeComposableValue)(tokenAddress)
                ? "RUNTIME_VALUE"
                : tokenAddress,
            fromAddress: accountAddress,
            toAddress: recipient,
            amount: (0, composabilityCalls_1.isRuntimeComposableValue)(amount)
                ? "RUNTIME_VALUE"
                : amount,
            chainId
        }
    ];
    return [
        ...currentInstructions,
        {
            calls: triggerCalls,
            chainId,
            isComposable: isComposableCall,
            metadata: metadata || defaultMetadata
        }
    ];
};
exports.buildTransfer = buildTransfer;
exports.default = exports.buildTransfer;
//# sourceMappingURL=buildTransfer.js.map